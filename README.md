# Каталог соединителей Iset

Проект представляет собой каталог соединителей типа 2РМТ, 2РМДТ и других электрических соединителей с реализацией API для получения данных.

## Описание проекта

Система предоставляет API для получения информации о соединителях из базы данных PostgreSQL. Проект состоит из трех слоев:
1. БД - PostgreSQL база данных с таблицами, хранящими информацию о соединителях
2. API - FastAPI приложение, предоставляющее REST API для доступа к данным
3. Frontend (планируется в будущем) - React Native приложение для отображения каталога

## Структура проекта

```
Iset_katalog4/
├── api/                    # Модуль API
│   ├── models/             # Модели данных (Pydantic)
│   ├── routers/            # Маршруты API
│   ├── database.py         # Работа с базой данных
│   └── main.py             # Основное FastAPI приложение
├── database/               # Модуль работы с базой данных
│   ├── connection/         # Подключение к БД
│   ├── data/               # Данные для заполнения БД
│   ├── schema/             # Схемы таблиц
│   ├── queries/            # SQL запросы
│   ├── migrations/         # Миграции БД
│   ├── functions/          # Функции для работы с БД
│   └── Zapchasti/          # Папка с изображениями и исходниками
│       └── 2РМТ, 2РМДТ/    # Изображения для соединителей типа 2РМТ и 2РМДТ
│           └── ishodniki/  # Исходные файлы
│               └── PNG/    # PNG и SVG изображения соединителей
│                   └── PDF/# PDF файлы с техническими чертежами
├── .env                    # Переменные окружения
├── check_db.py             # Скрипт проверки структуры и целостности БД
├── run_api_server.py       # Скрипт запуска API сервера
└── requirements.txt        # Зависимости проекта
```

## Требования

- Python 3.9+
- PostgreSQL 13+
- Зависимости из requirements.txt

## Установка и настройка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/domawnuy/Iset_katalog_new.git
cd Iset_katalog_new
```

2. Создайте виртуальное окружение и установите зависимости:
```bash
python -m venv .venv
source .venv/bin/activate  # На Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

3. Настройте подключение к базе данных PostgreSQL:
   - Создайте файл `.env` в корневой директории проекта
   - Укажите параметры подключения к БД:
```
DB_NAME=connector_catalog
DB_USER=postgres
DB_PASSWORD=ваш_пароль
DB_HOST=localhost
DB_PORT=5432
```

4. Инициализируйте базу данных с помощью миграций:
```bash
python -m database.migrations.migration_runner
```

## Запуск API сервера

Для запуска API сервера выполните:
```bash
python run_api_server.py
```

Сервер будет доступен по адресу: http://localhost:8000

Документация API (Swagger): http://localhost:8000/docs

## Проверка структуры базы данных

Для проверки структуры и целостности базы данных выполните:
```bash
python check_db.py
```

Скрипт проверит:
- Наличие всех необходимых таблиц
- Структуру таблиц (колонки, типы данных)
- Корректность работы ключевых SQL-запросов API
- Наличие внешних ключей и связей между таблицами

## API эндпоинты

### 1. Получение списка групп изделий

```
GET /api/Groups/GetGroups
```

**Ответ:**
```json
[
  {
    "group_id": 1,
    "group_name": "2РМТ"
  },
  {
    "group_id": 2,
    "group_name": "2РМДТ"
  }
]
```

### 2. Получение списка изделий в группе с пагинацией

```
GET /api/Products/GetProductsByGroupId?group_id=1&page=1&page_size=10
```

**Параметры:**
- `group_id` - идентификатор группы изделий
- `page` - номер страницы (начиная с 1)
- `page_size` - количество элементов на странице (от 1 до 100)

**Ответ:**
```json
{
  "items": [
    {
      "product_id": 5,
      "product_name": "2РМТ",
      "product_image_path": "/api/Images/GetProductImage/5"
    }
  ],
  "total_count": 1,
  "page": 1,
  "page_size": 10
}
```

### 3. Получение детальной информации об изделии

```
GET /api/Products/GetById?product_id=5
```

**Параметры:**
- `product_id` - идентификатор изделия

**Ответ:**
```json
{
  "connector_id": 5,
  "full_code": "2РМТ",
  "gost": "ГОСТ В 23476.8-86",
  "connector_type": "2РМТ",
  "body_size": "стандартный",
  "body_type": "стандартный",
  "contact_coating": "золото",
  "heat_resistance": 100,
  "climate_design": "УХЛ",
  "connection_type": "резьбовое",
  "contacts_info": [
    {
      "diameter": 1.0,
      "max_resistance": 5.0,
      "max_current": 8.0
    }
  ],
  "documentation": [
    {
      "doc_name": "Техническая спецификация",
      "doc_path": "/api/Documents/GetDocumentById/1?product_id=5",
      "description": "Спецификация для 2РМТ",
      "upload_date": "2024-01-01"
    }
  ],
  "images": [
    "/api/Images/GetProductImage/5",
    "/api/Images/GetProductImage/5?view=front",
    "/api/Images/GetProductImage/5?view=side",
    "/api/Images/GetTechnicalDrawing/5"
  ],
  "created_at": "2024-01-01",
  "updated_at": "2024-01-01"
}
```

### 4. Поиск продуктов в каталоге

```
GET /api/Products/Search?query=2РМТ&limit=30
```

**Параметры:**
- `query` - текст для поиска (минимальная длина - 2 символа)
- `limit` - максимальное количество результатов (от 1 до 100, по умолчанию 30)

**Ответ:**
```json
[
  {
    "product_id": 5,
    "product_name": "2РМТ",
    "product_image_path": "/api/Images/GetProductImage/5"
  },
  {
    "product_id": 6,
    "product_name": "2РМДТ",
    "product_image_path": "/api/Images/GetProductImage/6"
  }
]
```

**Особенности поиска:**
- Поиск выполняется по имени серии, описанию, названию и коду типа соединителя, размеру корпуса, параметрам
- Реализована строгая валидация поисковых запросов с информативными сообщениями об ошибках
- Поиск учитывает различные варианты написания обозначений соединителей
- Поддерживается поиск по числовым значениям (например, по размеру корпуса)

**Примеры ошибок валидации:**
```json
{
  "detail": "Размер корпуса 25 не найден в базе данных. Доступные размеры: 14, 18, 22"
}

{
  "detail": "Запрос 'xyz123' не найден в базе данных. Примеры допустимых значений: типы соединителей: 2РМТ, 2РМДТ, серии: 2РМТ, 2РМДТ, размеры: 14, 18, 22."
}
```

### 5. Получение изображений

```
GET /api/Images/GetProductImage/{product_id}
GET /api/Images/GetProductImage/{product_id}?view=front
GET /api/Images/GetProductImage/{product_id}?view=side
GET /api/Images/GetTechnicalDrawing/{product_id}
```

## Разработка

### Структура API

1. `api/models/` - Pydantic модели для валидации и сериализации данных
2. `api/routers/` - Маршруты API с разделением по функциональности:
   - `groups.py` - API группы соединителей
   - `products.py` - API получения информации о соединителях
   - `documents.py` - API работы с документацией
   - `images.py` - API доступа к изображениям
3. `api/database.py` - Модуль для работы с базой данных

### Работа с базой данных

Для работы с базой данных используется контекстные менеджеры:
```python
from api.database import get_db_cursor

with get_db_cursor() as cursor:
    cursor.execute("SELECT * FROM connector_types")
    results = cursor.fetchall()
```

## Последние обновления

### Обновление от 13.05.2024
- Реализован улучшенный эндпоинт поиска продуктов `/api/Products/Search` с расширенной проверкой данных
- Добавлена строгая валидация входных параметров во всех API-эндпоинтах
- Улучшены информативные сообщения об ошибках с рекомендациями по допустимым значениям
- Реализована нормализация поисковых запросов для учета различных вариантов написания обозначений
- Добавлены дополнительные проверки существования таблиц и правильности форматов данных

### Обновление от 13.05.2024 (предыдущее)
- Добавлено поле `type_id` в таблицу `connector_series` для корректной связи с `connector_types`
- Добавлены изображения для соединителей 2РМТ и 2РМДТ (PNG, SVG, PDF)
- Исправлены запросы API для корректного получения продуктов по группе
- Добавлен скрипт проверки структуры и целостности БД (`check_db.py`)
- Обновлена документация и улучшены описания API-эндпоинтов 

## Запуск в Docker

### Требования

Для запуска проекта в Docker необходимо установить:
- [Docker](https://www.docker.com/products/docker-desktop/) (для Windows/Mac) или Docker Engine (для Linux)
- Docker Compose (входит в состав Docker Desktop)

### Инструкция по развертыванию

#### 1. Клонирование репозитория

```bash
git clone https://github.com/domawnuy/Iset_katalog_new.git
cd Iset_katalog_new
```

#### 2. Запуск Docker-контейнеров

##### Windows:
```bash
docker\start_docker.bat
```

##### Linux/Mac:
```bash
chmod +x docker/start_docker.sh
./docker/start_docker.sh
```

Скрипт запуска выполнит следующие операции:
- Сборка Docker-образа для API на основе Dockerfile
- Запуск контейнера PostgreSQL
- Автоматическая инициализация базы данных скриптами из директории `database/schema`
- Запуск API-сервера после успешной инициализации базы данных

#### 3. Проверка работоспособности

После успешного запуска:
- API доступен по адресу: http://localhost:8000
- Документация API (Swagger UI): http://localhost:8000/docs
- База данных PostgreSQL доступна на порту 5432

Для проверки состояния контейнеров можно использовать специальные скрипты:

##### Windows:
```bash
docker\check_docker.bat
```

##### Linux/Mac:
```bash
chmod +x docker/check_docker.sh
./docker/check_docker.sh
```

Скрипты проверки выполнят:
- Вывод статуса запущенных контейнеров
- Проверку доступности API
- Проверку подключения к базе данных
- Вывод последних строк логов API-сервера

#### 4. Остановка контейнеров

Для остановки Docker-контейнеров:

##### Windows:
```bash
docker\stop_docker.bat
```

##### Linux/Mac:
```bash
chmod +x docker/stop_docker.sh
./docker/stop_docker.sh
```

При остановке контейнеров данные базы данных сохраняются в именованном Docker-томе и не будут потеряны.

### Структура Docker-инфраструктуры

- **docker/docker-compose.yml** - основной файл конфигурации, описывающий сервисы:
  - **db** - контейнер с PostgreSQL
  - **api** - контейнер с FastAPI-приложением

- **docker/Dockerfile** - описание сборки образа для API-сервера
- **docker/.dockerignore** - список файлов, исключаемых при сборке образа

### Доступ к базе данных из контейнера

Для подключения к базе данных из контейнера используются следующие параметры:
- **Хост**: db
- **Порт**: 5432
- **Имя БД**: connector_catalog
- **Пользователь**: postgres
- **Пароль**: aboba1337

### Доступ к базе данных извне контейнера

Для подключения к базе данных с хост-машины:
- **Хост**: localhost
- **Порт**: 5432
- **Имя БД**: connector_catalog
- **Пользователь**: postgres
- **Пароль**: aboba1337

Пример подключения с использованием psql:
```bash
psql -h localhost -p 5432 -U postgres -d connector_catalog
```

### Возможные проблемы и их решение

#### 1. Порт 5432 или 8000 уже занят

Если порты 5432 (PostgreSQL) или 8000 (API) уже заняты другими приложениями, измените порты в файле `docker/docker-compose.yml`:

```yaml
services:
  db:
    ports:
      - "5433:5432"  # Изменено с 5432:5432
  api:
    ports:
      - "8080:8000"  # Изменено с 8000:8000
```

#### 2. Ошибка подключения к базе данных из API

Если API не может подключиться к базе данных, убедитесь, что:
- Контейнер PostgreSQL запущен и работает
- В файле `docker-compose.yml` правильно указаны переменные окружения для API (DB_HOST=db)

Для проверки статуса базы данных:
```bash
docker exec iset-katalog-db pg_isready -U postgres -d connector_catalog
```

#### 3. Ошибки инициализации базы данных

Если скрипты инициализации базы данных завершаются с ошибками, проверьте логи контейнера PostgreSQL:
```bash
docker logs iset-katalog-db
```

### Дополнительная информация

Для удобства использования Docker рекомендуется:

1. Использовать именованные тома для сохранения данных базы данных между запусками контейнеров
2. Настроить автоматический перезапуск контейнеров в случае сбоя или перезагрузки системы
3. Проверять логи контейнеров для диагностики проблем

Все эти рекомендации уже реализованы в текущей Docker-конфигурации проекта. 